# streamflow_WesternUS
The NWIS_Streamgage_R_Filter.Rmd filters the USGS NWIS streamgage data as much as possible using the dataRetrieval package. It creates a .csv file for all the streamgages in a state that meet the following criteria: site type = stream, at least 10 years of daily mean discharge values, each of the 10 years of observations consists of at least 335 observations, streamgage names do not include terms that suggest anthropgonenic impact such as dam, res, div, channel, etc.

Another .csv file is created with that includes the coordinates of every streamgage in the state that meets the above mentioned criteria. This streamgage coordinate data will be used in ArcGIS to spatialy analyze the relation between streamgages, dams, and streams to look for any streamgages downstream of dams that the filtering in R could not detect. There are two small things that I want to fix in this .Rmd. I need to re-run Section 2 Step 4 which take over an hour and then save the output as a .csv file that includes Site_Name and gets rid of the X variable / column. 

I wanted to upload the AZ_readNWISdv_Filter_Qual_Code.csv file to GitHub so you wouldn't have to run Section 2 Step 4 since it takes over an hour. Unfortuneately, the file is too large, so if you want to test NWIS_Streamgage_R_Filter.Rmd, you will have to use readNWISdv in Section 2 Step 4, which took between 1 and 1.5 hours to run on my Mac. After doing this on the initial run, you can save the output you got in Section 2 Step 4 to a .csv file in Section 2 Step 8. Then if you run this code again for the same state (AZ), you don't have to wait an hour each time. So the first time you run NWIS_Streamgage_R_Filter.Rmd do Section 2 Steps 4 - 8 and skip Section 2 Step 9. You can run Section 2 Step 10 any either run if you want.

To test NWIS_Streamgage_R_Filter.Rmd, the AZ_readNWISdv_Filter_Qual_Code.csv should be downloaded from this repo. This will allow you to skip Section 2 Steps 4 - 8 in NWIS_Streamgage_R_Filter.Rmd. Section 2 Step 4 uses readNWISdv to get all of the daily mean discharge values for all streamgages in a state for all of their observations. For Arizona, this retrieved 3,254,235 results and took over an hour to complete on my Mac. Using the AZ_readNWISdv_Filter_Qual_Code.csv allows you to skip this waiting time. More info in NWIS_Streamgage_R_Filter.Rmd.

After doing all of the filtering in  NWIS_Streamgage_R_Filter.Rmd, there are still streamgages that are downsteram of dams. 

The NID_Data_Retrieval.Rmd downloads data from the US Army Corps of Engineers' National Inventory of Dams for you state of interest. It outputs a .csv file with Federal ID, Dam Name, Latitude, Longitude, County and State, and River or Stream Name. This data will be used in ArcGIS to spatialy analyze the relation between streamgages, dams, and streams to look for any streamgages downstream of dams that the filtering in R could not detect.

There is also the USGS National Hydrography Dataset. This dataset appears to have GDB, GPKG, and Shape files for all streams in the country. My thought is to download this data for the state of interest and import the appropriate type of data to ArcGIS Pro. It should represent all of the streams as lines. Then we could add a buffer to these lines to account for any innaccuracies in coordinate data for the streamgages or dams. The buffer should output a polygon that represents the river. Then we could use spatial join to see which streamgages and dams both are on the same river. Maybe we can also find out if the streamgage is downstream from the dam on the same river. This will require more research on my part.

To download USGS National Hydrgraphy Dataset for a specific state go to https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Hydrography/NHD/State/ . Then click on the file type you are interested in, then find the state you want in the list.

I also found a .xlsx spreadsheet that has all of the streamgages included in the USGS Hydro-Climatic Data Network. It can be downloaded at https://water.usgs.gov/osw/hcdn-2009/ . On my web browser this pages appears to be mostly empty. Highlight the entire page to reveal the secret hidden text. Then click on the “A complete list of stations comprising HCDN-2009, along with basic attributes is given in the Excel file HCDN-2009_Station_Info.xlsx.” link to download it. I then uploaded it to Google Drive and opened it with Google Sheets. In Google Sheets go to File > Download > Comma Separated Values (.csv). Now we can look at this data in R. I haven't looked at it much yet but saw that the columns aren't labeled but the important info such as Site Number, Site Name, State, Longitutde, and Latitude are easy to figure out. 


Perhaps with this USGS HCDN data we could include all of those streamgages in our data. We would also have to check for any streamgages that have been installed post USGS HCDN and also check the National Inventory of Dams to see if any dams have been built post USGS HCDN.

Let me know what questions you have and what needs to be changed. 

Update for Reservoirs_or_Diversion.Rmd
For answering the question, "The NID dataset provides some information on the use of the dam, we may only filter out dams that serve as reservoirs as opposed to diversion dams. Is there a way to easily differentiate these uses from the NID data?", my idea is to go through the NID dataset and find the most promising attributes. Then for each attribute find the distribution for each of the values. For example, for Spillway.Type, 46% are uncontrolled, 37% have no value, 9% are controlled, and 8% have the value None. I think the biggest obstacle here will be all of the missing values. I thought Spillway.Type would be a good indicator but over one third of the observations do not have data for that attribute. 

At the moment my idea is to find the attributes that could indicate if the dam impedes the flow of the river and then see what percent of those attributes are missing. If I can find a promiising attribute with a minimal amount of missing values, I could then do a random sample of dams and look it up on satellite imagery and see if it looks like it holds water. My rough idea is to do a binomial distribution where doesn't impede a river's flow is indicated with a 1 and does impede a river's flow is 0. Maybe I can make some sort of regression model that uses the different attributes to predict if a dam impedes the flow of the river or not. I'm trying to remember my last stats class but this will give me a reason to relearn it, which is a good thing. 

Let me know if this sounds reasonable and or coherent.

